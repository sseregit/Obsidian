# 분산 추적

## 문제점
- 시스템 환경에 대한 외부 요청을 처리하는 동안 마이크로서비스 사이에서 흐르는 요청 및 메시지를 추적할 수 있어야 한다.

### 장애 시나리오의 에
- 최종 사용자가 특정 장애에 대한 해결을 요청했을 때 문제를 일으킨 마이크로서비스를 찾고 근본 원인을 밝히려면 어떻게 해야 하는가?
- 특정 엔티티와 관련된 문제를 지원하고자 이와 관련된 모든 로그 메시지를 찾고 싶다. 예를 들어 어떤 주문 번호에 대한 문제가 발생했을 때 해당 주문의 처리에 관여한 모든 마이크로서비스의 로그 메시지를 찾으려면 어떻게 해야 하는가?
- 최종 사용자가 지나치게 긴 응답 시간에 대한 불만을 토로하기 시작했다. 호출 체인에 속한 마이크로서비스 중 어떤 마이크로서비스가 지연을 일으키는지 식별하려면 어떻게 해야하는가?
## 해결책
- 공조 마이크로서비스 사이의 처리 과정을 추적하려면 관련된 모든 요청 및 메시지에 **상관 ID**를 넣어야 하고, 모든 로그 이벤트에 상관 ID가 있어야 한다. 중앙화된 로깅서비스에서 상관 ID를 검색하면 관련된 로그 이벤트를 모두 찾을 수 있다. 비즈니스 관련 식별자가 포함된 로그 이벤트를 찾은 다음 상관ID로 검색하면 해당 비즈니스 식별자와 관련된 모든 로그 이벤트를 찾을 수 있다.
- 공조 마이크로서비스 호출 체인에서 지연 원인을 찾으려면 요청, 응답, 메시지가 각 마이크로서비스에 들어오고 나가는 시간에 대한 타임스탬프를 수집할 수 있어야 한다.
### 해결책의 필수 조건
- 모든 수신 요청과 이벤트에 고유 상관 ID를 할당한다. 상관 ID는 헤더와 같이 찾기 쉬운 위치에 넣는다.
- 마이크로서비스에서 외부로 요청이나 메시지를 보낼 때는 요청과 메시지에 상관 ID를 꼭 넣는다.
- 모든 로그 이벤트에는 사전에 정의한 형식의 상관 ID가 있어야 한다. 중앙화된 로깅 서비스는 로그 이벤트에서 상관 ID를 추출해 검색할 수 있다.
- 요청, 응답, 메시지가 마이크로서비스 인스턴스로 들어가거나 나갈 때마다 추적 레코드를 생성해야 한다.
### 책에서 제안하는 오픈 소스 도구
- 스프링 클라우드
	- 스프링 클라우드 슬루스와 집킨
- 이스티오
	- 예거